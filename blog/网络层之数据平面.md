# 网络层之数据平面

计算机的网络层可以分为数据平面和控制平面。**数据平面**执行的任务是转发功能，就是将数据从路由器的输入端口，发送到输出端口。**控制平面**执行的功能是路由选择功能，就是选择报文从源地址到目的地址经过的路由器的路径。这里主要讲的路由器如何转发一个报文(数据平面)，然后将一下`IP`报文。

## 1. 路由器的功能

路由器的转发有两种，基于目的的转发和通用转发，这里我们用基于目的的转发，后面将`IP`的时候再讲通用转发。

下图展示了路由器的总体功能：

![路由器](E:\Repo\Blog photo\数据平面\路由器.png)

下面将路由器分成输入端口，交换结构和输出端口来讲解。

### 1.1 输入端口

在每一个输入端口里，都有一个**转发表**。输入端口会通过将**报文的目的地址与转发表相匹配**来决定将报文发送到哪个输出端口。

下面是一个例子看图：

![转发表 1](E:\Repo\Blog photo\数据平面\转发表 1.png)

图中是一个转发表，匹配采用的是**最大前缀匹配规则**。假设我们的`IP`地址是`11001000 00010111 00011000 10100001`，这个地址同时与第`2`项和第`3`项匹配上了，但是根据最大前缀匹配规则，我们选择的第`2`项，将报文发送的`1`号输出端口(`link interface`在这里是链路接口)。

### 1.2交换结构

交换结构决定如何将一个报文从输入端口发送到输出端口。经典的有三种方式，总线，内存和纵横式。

下面是介绍这三种交换方式的各自的特点：

- **总线**，一次只能通过一个分组。
- **内存**，一次仅能执行一个内存的读写。
- **纵横式**，当报文的目的端口不是同一个时，可以并行地发送多个报文。

### 1.3 输出端口

到达输出端口后，输出端口将报文发送出去。

### 1.4 排队现象

#### 1.4.1 输入排队

即使交换结构很快，在输入端口仍然可能发生排队现象。

在下图中，我们采用**纵横式**的交换结构，假设现在在输入队列的报文如下，同时我们假定当**队列中要发送的报文相同时，优先发送上面队列的报文**。

1. 第一次发送时：由于上下队列中的要发送的报文相同，优先发送上面的报文到对应的输出端口。同时**并行**的发送中间队列的报文到对应的输出端口(对应第一张图)。
2. 第二次发送时：由于上下队列中的要发送的报文还是相同的，优先发送上面的报文到对应的输出端口(对应第二张图)。
3. 第三次发送时：现在只有下面的队列有报文，发送第一个报文。此时下面还剩下一个报文。

于是我们看到，即使没有和下面的第二个报文竞争中间输出端口的，但是他依然等待了三个报文发送时间，这种现象叫做输入队列的**线路前部阻塞(HOL)**。

![hol](E:\Repo\Blog photo\数据平面\hol.png)

#### 1.4.2 输出排队

当到达报文的速度超过输入端口发送报文的速度时，报文会丢失。当输出队列满了的时候，一是采取**弃尾**，把后面到达的报文全部丢弃，二是删除前面的分组，给新的分组提供位置。在某些情况下，可以在队列满之前，先丢弃一个分组(或在首部添加标志)，这可以向发送方发送一个拥塞信号，来调控阻塞情况。

同时当报文在输出队列排队是，还涉及到了**分组调度**，即如何排队。现在有三种排队方法，先进先出，优先权排队和循环和加权公平排队。

- **先进先出**，就是先来的报文也先发送出去，这和我们日常排队买东西一样。
- **优先权排队**，将队列分为优先权高的和低的，只要优先权高的有分组，就先发送他的分组。这就和我们有应急车道差不多。
- **循环和加权公平排队**，**循环排队**就是把报文分成几类，然后循环的一类一类的发送报文。**加权公平排队**把报文分成几类，并且第$i$类的权重为$w_i$，加权公平排队保证第$i$类接受到的服务等于$w_i/\sum w_i$。

## 2. IP报文

### 2.1 报文格式



### 2.2 IP编址



### 2.3 DCHP



### 2.4 NAT



### 2.5 流表

